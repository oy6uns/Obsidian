1. 사용자 프로그램이 `{cpp}read()` 또는 `{cpp}write()`와 같은 System Call을 실행한다. 
2. 이 호출은 라이브러리 함수 또는 어셈블리 인터페이스(`usys.S`)를 통해 커널에 요청된다.
3. 어셈블리 인터페이스(`usys.S`)는 시스템 호출 번호를 설정한 후 `int 64`를 실행하여 커널 모드로 전환한다. 
4. ==사용자 모드의 상태가 Kernel Stack에 저장==되고, 커널 모드에서 시스템 호출 처리를 시작한다. 
   →  사용자 모드의 상태(CPU 레지스터, 프로그램 카운터, 플래그) 등이 User Stack이 아닌 Kernel Stack에 저장되는 이유는 악의적인 프로그램이 이 데이터를 조작하거나 손상시킬 수 없게끔 하기 위해서이다. 
5. 커널은 ==시스템 호출 번호(EAX 레지스터)를 확인==하고, 해당 핸들러 함수(예:`sys_read`, `sys_write`)를 실행한다. 
6. 저장된 상태를 복구하고, 사용자 모드로 돌아간다. 

### 커널 메모리의 역할
#### **언제 사용되는가?**
- **시스템 호출 처리**:
    - 사용자 모드에서 커널 모드로 전환되면, 커널 스택이 활성화됩니다.
    - 시스템 호출 처리 중 함수 호출 기록과 로컬 변수가 커널 스택에 저장됩니다.
- **인터럽트 처리**:
    - 하드웨어 인터럽트가 발생하면, 커널 스택에 현재 상태를 저장하고 인터럽트를 처리합니다.
- **문맥 교환**:
    - 현재 프로세스의 커널 스택에 상태를 저장한 후, 다음 프로세스의 커널 스택을 복원합니다.
#### 커널 스택과 커널 힙
- ==**커널 스택**==은 프로세스의 커널 모드 실행 중 임시 데이터를 저장하며, ==프로세스별로 독립적이고 크기가 작습니다==.
- ==**커널 힙**==은 운영체제에서 동적으로 메모리를 할당해야 할 때 사용되며, ==커널 전체에서 공유됩니다.==


## Assembly trap handler
##### 1. 사용자 모드(User Mode)
1. **`int n` 명령어**는 소프트웨어 인터럽트를 발생시켜 트랩 핸들러인 `alltraps`를 호출한다. CPU는 ==IDT (Interrupt Descriptor Table)를 참조하여 사용자 모드에서 커널 모드로 전환==한다.  ![[IMG-20250123124959.png]]
##### 2. 커널 모드(Kernel Mode)
2. CPU가 `alltraps`로 진입하고, 현재 CPU상태를 저장하고, 커널 환경을 설정한다. 
3. `alltraps`는 스택에 저장된 현재 상태의 주소를 `trap`함수에 전달한다. 
4. `trap`함수는 전달받은 트랩 프레임을 기반으로 예외나 인터럽트를 처리한다. 
   - 트랩 번호(`trapno`)가 시스템 호출(T_SYSCALL, 64)인지 확인한다. 
   - 트랩 번호가 시스템 호출일 경우, `syscall()` 함수를 호출하여 구체적인 작업을 수행한다. 
## System Call
##### 1. 트랙 프레임(`struct trapframe`)
```cpp
void trap(struct trapframe *tf) { 
	if (tf->trapno == T_SYSCALL) { 
		proc->tf = tf; // 현재 프로세스의 트랩 프레임 설정 
		syscall(); // 시스템 호출 처리 함수 호출 
	} 
}
```
- 커널 스택에 저장된 현재 CPU상태를 나타낸다. 
- 시스템 호출 번호는 `%eax` 레지스터에 저장되어 있다. 
##### 2. `syscall.c` 코드
```cpp
void syscall(void) {
    int num = proc->tf->eax;   // 시스템 호출 번호
    if (num > 0 && num < N_SYSCALL && syscalls[num]) {
        proc->tf->eax = syscalls[num](); // 호출된 시스템 함수 실행
    }
}
```
- 시스템 호출 번호를 기반으로 함수 포인터 배열(`syscalls[]`)에서 적절한 핸들러를 호출한다. 
- 결과는 다시 `%eax` 레지스터에 저장된다. 
##### 시스템 호출 인자의 처리
- 시스템 호출에 전달된 인자들은 사용자 스택(user stack)에 저장된다. 
- 커널 스택에 있는 트랩 프레임의 `%esp` 값을 사용하여 사용자 스택에서 인자를 가져온다. 
- `argint`, `argptr`, `argstr`등 헬퍼 함수를 인자를 읽는 데 사용한다. 
	예시: 
```cpp
int argint(int n, int *ip) {
    return fetchint(proc->tf->esp + 4 + 4*n, ip);
}
```
