## Aggreagtion Strategies in PostgreSQL
> aggregation기법

Aggregatoin: 집계 함수
→ 테이블 전체에 대해서도 적용되기도 했지만, group by랑도 함께 쓰였음

`Explain Analyze` 를 붙여서 query를 보내면 query를 실행하면서 걸린 실행동작들에 대한 break down들이 나오게 된다. 

### Hash-Based Aggregation
- **해시 테이블**을 통해 **aggregation** 결과값을 **메모리**(`work_mem`)에 저장한다. 
- 만약 처리할 데이터가 너무 커서 `work_mem`으로 설정된 **메모리 용량**을 초과하면, PostgreSQL은 데이터를 **디스크로 옮겨** 처리한다. 
- 이때, 디스크 공간에 데이터를 여러 **파티션**으로 나누어 저장하고, 각각의 **파일**에서 **블록 단위로 I/O 작업**을 처리하게 된다. 
예시)
```
해시 값: 0x7b3e2d1c
-> 일부 비트를 사용해서 파티션을 나눈다. 

상위 8비트: 01111011 (0x7b) 사용해서 파티션을 결정
256개의 파티션 중 하나로 분배된다. 
```
위의 방법을 사용할 때 하나의 파티션에 너무 많은 데이터가 들어간다면, 추가적인 비트를 더 추출해서 파티션 수를 더 늘릴 수 있다. 
```
상위 12비트: 011110110011 (0x7b3e) 
이는 4096개의 파티션 중 하나로 분배된다.
```
**더 많은 비트를 사용**하면, 더 많은 **파티션**을 생성할 수 있게 되어, 각 파티션의 데이터 양이 줄어들고 **메모리나 디스크에 더 효율적으로 분배**된다.
### Sort-Based Aggregation
데이터를 정렬한 후 그룹화 및 집계를 수행한다. 

데이터가 클 때 안정적이며
데이터가 이미 정렬된 경우에 빠르게 동작한다. 

데이터가 메모리 내에서도 충분히 동작 가능하다면, **메모리 내 정렬**이 수행된다. 
데이터가 너무 커서 메모리에 담을 수 없는 경우, **디스크 기반 정렬**을 수행한다. 
- 디스크 기반 정렬은 **외부 정렬 알고리즘(External Merge Sort)** 을 사용한다. 
	- 데이터를 메모리에 적합한 크기로 나누어 정렬
	- 정렬된 데이터를 디스크에 임시 저장
	- 나중에 정렬된 조각들을 병합하여 최종 정렬된 결과를 생성

## Configuration Parameters
> aggregation에 영향을 줄 수 있는 파라미터들

- work_mem
  해당 작업을 시행할 때, 사용할 메모리의 상한
- max_parallel_workers
  해당 작업을 시행할 때, 사용할 병렬 작업자의 수


